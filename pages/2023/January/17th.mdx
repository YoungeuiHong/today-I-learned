# 17th January, 2023

## ğŸ§© State Colocation
- input ìš”ì†Œê°€ ì—¬ëŸ¬ ê°œì¼ ë•Œ, í•œ inputì˜ ìœ íš¨ì„± ìƒíƒœ ë³€ê²½ ë•Œë¬¸ì— ëª¨ë“  ì»´í¬ë„ŒíŠ¸ê°€ ë¦¬ë Œë”ë§ ë  í•„ìš”ëŠ” ì—†ìŒ
- ë”°ë¼ì„œ ë¦¬ë Œë”ë§ì´ í•„ìš”í•œ ì»´í¬ë„ŒíŠ¸ë§Œ ë¶„ë¦¬í•˜ì—¬, ë¦¬ë Œë”ë§ë˜ëŠ” ë²”ìœ„ë¥¼ ì¢íˆëŠ” ë°©ë²•ì´ ë§ì´ ì“°ì„
- ì´ëŸ° ì‹ìœ¼ë¡œ ì»´í¬ë„ŒíŠ¸ì˜ ìƒíƒœë¥¼ ì„œë¡œ ê´€ë ¨ì´ ìˆëŠ” ê²ƒë“¤ë¼ë¦¬ë§Œ ëª¨ì•„ ë¶„ë¦¬í•˜ì—¬ ìœ„ì¹˜ì‹œí‚¤ëŠ” ë°©ë²•ì„ State Colocationì´ë¼ í•¨

## ğŸ§ React Query, ì™œ í•„ìš”í• ê¹Œ?
[React Queryì™€ ìƒíƒœ ê´€ë¦¬ :: 2022ë…„ 2ì›” ìš°ì•„í•œí…Œí¬ ì„¸ë¯¸ë‚˜](https://youtu.be/MArE6Hy371c)

### ìƒíƒœ ê´€ë¦¬ ë¼ì´ë¸ŒëŸ¬ë¦¬ì˜ Store ê´€ë ¨ ë¬¸ì œ

- StoreëŠ” ì „ì—­ ìƒíƒœê°€ ì €ì¥ë˜ê³  ê´€ë¦¬ë˜ëŠ” ê³µê°„ì¸ë° API í†µì‹  ì½”ë“œê°€ ì£¼ë¥¼ ì´ë£¨ê²Œ ë˜ëŠ” ë¬¸ì œ
- ìƒíƒœ ê´€ë¦¬ ì˜ì—­ì´ ì„œë²„ê°’ì„ ì €ì¥í•˜ëŠ” ë°ê¹Œì§€ í™•ì¥ë¨
- isFetching, isError ë“± API ê´€ë ¨ ìƒíƒœ ì½”ë“œê°€ ë°˜ë³µë¨

### ì„œë²„ì—ì„œ ë°›ì•„ì•¼ í•˜ëŠ” ìƒíƒœë“¤ì˜ íŠ¹ì„±
- í´ë¼ì´ì–¸íŠ¸ê°€ ì œì–´í•˜ê±°ë‚˜ ì†Œìœ í•˜ì§€ ì•ŠëŠ” ì›ê²©ì˜ ê³µê°„ì—ì„œ ê´€ë¦¬ë˜ê³  ìœ ì§€ë¨
- Fetchingì´ë‚˜ Updatingì— ë¹„ë™ê¸° APIê°€ í•„ìš”í•¨
- ë‹¤ë¥¸ ì‚¬ëŒë“¤ê³¼ ê³µìœ ë˜ëŠ” ê²ƒìœ¼ë¡œ ì‚¬ìš©ìê°€ ëª¨ë¥´ëŠ” ì‚¬ì´ì— ë³€ê²½ë  ìˆ˜ ìˆìŒ
- ì‹ ê²½ ì“°ì§€ ì•ŠëŠ”ë‹¤ë©´ ì ì¬ì ìœ¼ë¡œ out of dateê°€ ë  ê°€ëŠ¥ì„±ì„ ì§€ë‹˜

### Client State vs. Server State
âœ” Client State
- Clientì—ì„œ ì†Œìœ í•˜ë©° ì˜¨ì „íˆ ì œì–´ ê°€ëŠ¥í•¨
- ì´ˆê¸°ê°’ ì„¤ì •ì´ë‚˜ ì¡°ì‘ì— ì œì•½ì‚¬í•­ ì—†ìŒ
- ë‹¤ë¥¸ ì‚¬ëŒë“¤ê³¼ ê³µìœ ë˜ì§€ ì•Šìœ¼ë©° Client ë‚´ì—ì„œ UI/UX íë¦„ì´ë‚˜ ì‚¬ìš©ì ì¸í„°ë ‰ì…˜ì— ë”°ë¼ ë³€í•  ìˆ˜ ìˆìŒ
- í•­ìƒ Client ë‚´ì—ì„œ ìµœì‹  ìƒíƒœë¡œ ê´€ë¦¬ë¨ï¸

âœ”ï¸ Server State
- Clientì—ì„œ ì œì–´í•˜ê±°ë‚˜ ì†Œìœ í•˜ì§€ ì•ŠëŠ” ì›ê²©ì˜ ê³µê°„ì—ì„œ ê´€ë¦¬ë˜ê³  ìœ ì§€ë¨
- Fetchingì´ë‚˜ Updatingì— ë¹„ë™ê¸° APIê°€ í•„ìš”í•¨
- ë‹¤ë¥¸ ì‚¬ëŒê³¼ ê³µìœ ë˜ëŠ” ê²ƒìœ¼ë¡œ ì‚¬ìš©ìê°€ ëª¨ë¥´ëŠ” ì‚¬ì´ì— ë³€ê²½ë  ìˆ˜ ìˆìŒ
- ì‹ ê²½ ì“°ì§€ ì•ŠëŠ”ë‹¤ë©´ ì ì¬ì ìœ¼ë¡œ out of dateê°€ ë  ê°€ëŠ¥ì„±ì„ ì§€ë‹˜

### What is React Query?
- Fetch, cache and update data in your React application without touching any 'global state'.

## ğŸš€ React Query ì‚¬ìš© ë°©ë²•

### QueryClientProvider
```tsx
import { QueryClient, QueryClientProvider } from 'react-query'

const queryClient = new QueryClient();

function App() {
    return (
        <QueryClientProvider client={queryClient}>
            <div></div>
        </QueryClientProvider>
    );
}
```

### Queries
- Queriesì€ ë°ì´í„° Fetchingìš©. ì¦‰, CRUD ì¤‘ Readingì—ë§Œ ì‚¬ìš©ë¨

ğŸ“Œ Query Key
    - React QueryëŠ” Query Keyì— ë”°ë¼ query cachingì„ ê´€ë¦¬í•¨
    - QueryëŠ” String í˜•íƒœì™€ Array í˜•íƒœë¡œ ê´€ë¦¬í•  ìˆ˜ ìˆìŒ

ğŸ“Œ Query Function
    - Promiseë¥¼ ë°˜í™˜í•˜ëŠ” í•¨ìˆ˜ (ë°ì´í„° resolveë¥¼ í•˜ê±°ë‚˜ errorë¥¼ throw)

ğŸ“Œ Option
    - Configë¥¼ ì»¤ìŠ¤í…€ í•  ìˆ˜ ìˆìŒ
    - onSuccess, onError, onSettled: query fetching ì„±ê³µ/ì‹¤íŒ¨/ì™„ë£Œ ì‹œ ì‹¤í–‰í•  Side Effectë¥¼ ì •ì˜í•  ìˆ˜ ìˆìŒ

```tsx
import { useQuery } from 'react-query'

function App() {
    // todos: Query Key
    // fetchTodoList: Query Function
    const info = useQuery('todos', fetchTodoList);
}
```

![Query íŒŒì¼ ê´€ë¦¬](https://gitlab.com/public-space2/public-img/-/raw/main/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2023-01-17_%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE_3.16.13.png)

### Mutations
- MutationsëŠ” ë°ì´í„° ìƒì„±/ìˆ˜ì •/ì‚­ì œìš©ìœ¼ë¡œ ì‚¬ìš©ë¨. ì¦‰, CRUD ì¤‘ CUDì— ì‚¬ìš©ë¨
- useQueryë³´ë‹¤ ë” ì‹¬í”Œí•˜ê²Œ Promise ë°˜í™˜ í•¨ìˆ˜ë§Œ ìˆì–´ë„ ëœë‹¤.
- ë‹¨,
```tsx
const mutation = useMutation(newTodo => {
    return axios.post('/todos', newTodo)
})
```

ğŸ’¡ useMutation
```tsx
const {data, error, isError, isIdle, isLoading, isPaused, isSuccess, mutate, mutateAsync, reset, status} = useMutation(mutationFn, option);
```

ğŸ“Œ useMutationì˜ ë°˜í™˜ê°’
- mutate: mutationì„ ì‹¤í–‰í•˜ëŠ” í•¨ìˆ˜
- mutateAsync: mutateì™€ ë¹„ìŠ·í•˜ì§€ë§Œ Promiseë¥¼ ë°˜í™˜í•˜ëŠ” ì ì´ ë‹¤ë¦„
- reset: mutation ë‚´ë¶€ ìƒíƒœ clean

ğŸ“Œ useMutationì˜ Option
- onMutate: ë³¸ê²©ì ì¸ Mutation ë™ì‘ ì „ì— ë¨¼ì € ë™ì‘í•˜ëŠ” í•¨ìˆ˜. Optimistic updateë¥¼ ì ìš©í•  ë•Œ ìœ ìš©
- Optimistic Updateë€? í˜ì´ìŠ¤ë¶ ì¢‹ì•„ìš”ë¥¼ ì˜ˆë¡œ ì‚´í´ë³´ë©´ ì¢‹ì•„ìš”ë¥¼ ëˆ„ë¥´ë©´ ì¼ë‹¨ ë‚™ê´€ì ìœ¼ë¡œ ì„œë²„ í†µì‹ ì´ ì„±ê³µí•  ê²ƒì´ë¼ ë³´ê³  UIë¥¼ ë¨¼ì € ì—…ë°ì´íŠ¸í•˜ê³ , ë§Œì•½ ì„œë²„ í†µì‹ ì´ ì‹¤íŒ¨ë¥¼ í•˜ë©´ ë¡¤ë°±í•˜ëŠ” ê²ƒ.

### Query Invalidation
- Query Invalidationì„ í•˜ë©´ í•´ë‹¹ queryëŠ” stale ì·¨ê¸‰ë˜ê³ , í˜„ì¬ renderingë˜ê³  ìˆëŠ” queryë“¤ì€ ë°±ê·¸ë¼ìš´ë“œì—ì„œ refetchë¨
```tsx
// Invalidate all queries in the cache
queryClient.invalidateQueries();
// Invalidate all queries with a key that starts with 'todos'
queryClient.invalidateQueries('todos');
```

## ğŸ‘€ React Query Cachingê³¼ Synchronization

### RFC 5861
> HTTP Cache-Control Extensions for Stale Content

âœ”ï¸ stale-while-revalidate
- ë°±ê·¸ë¼ìš´ë“œì—ì„œ stale reponseë¥¼ revalidateí•˜ëŠ” ë™ì•ˆ ìºì‹œê°€ ê°€ì§„ stale responseë¥¼ ë°˜í™˜
```
Cache-Control:max-age=600,stale-while-revalidate=30
```
- stale responseëŠ” ì‹ ì„ í•˜ì§€ ì•Šì€ ë‚¡ì€ ë°ì´í„°ë¥¼ ì˜ë¯¸í•¨.
- ìœ„ ì½”ë“œë¥¼ ë³´ë©´ 600ì´ˆ ë‚´ì—ì„œëŠ” Cacheê°€ ìœ íš¨í•˜ê³ , 600ì´ˆë¥¼ ì§€ë‚˜ë©´ staleí•œ responseê°€ ë˜ëŠ” ê²ƒ
- ë‹¤ì‹œ ì„œë²„ë¡œ ìš”ì²­ì„ ë³´ë‚´ì„œ ë°ì´í„°ë¥¼ ë°›ì•„ì˜¤ëŠ” ë™ì•ˆ, 30ì´ˆ ë™ì•ˆì€ ìºì‹œê°€ ê°€ì§„ stale responseë¥¼ ë°˜í™˜í•˜ëŠ” ê²ƒ
- ì´ë¥¼ í†µí•´ Latencyë¥¼ ìˆ¨ê¸°ëŠ” íš¨ê³¼ë¥¼ ì–»ì„ ìˆ˜ ìˆìŒ

### ìœ„ ê°œë…ì„ ë©”ëª¨ë¦¬ ìºì‹œì—ë„ ì ìš©í•´ë³´ì
- cacheTime: ë©”ëª¨ë¦¬ì— ì–¼ë§ˆë§Œí¼ ìˆì„ ê±´ì§€ (í•´ë‹¹ ì‹œê°„ ì´í›„ GCì— ì˜í•´ ì²˜ë¦¬, default 5ë¶„)
- staleTime: ì–¼ë§ˆì˜ ì‹œê°„ì´ íë¥¸ í›„ì— ë°ì´í„°ë¥¼ stale ì·¨ê¸‰í•  ê²ƒì¸ì§€ (default 0)
- refetchOnMount / refetchOnWindowFocus / refetchOnReconnectê°€ trueì´ë©´ Mount / Window focus / Reconnect ì‹œì ì— dataê°€ staleì´ë¼ê³  íŒë‹¨ë˜ë©´ ëª¨ë‘ refetch
![Query ìƒíƒœ íë¦„](https://gitlab.com/public-space2/public-img/-/raw/main/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2023-01-17_%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE_6.02.27.png)
![Query ìƒíƒœ íë¦„(active)](https://gitlab.com/public-space2/public-img/-/raw/main/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2023-01-17_%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE_6.05.03.png)

### React Queryì˜ Defaultê°’ (zero-config)
- Queriesì—ì„œ cached dataëŠ” ì–¸ì œë‚˜ stale ì·¨ê¸‰ëœë‹¤.
- ê° ì‹œì ì—ì„œ dataê°€ staleì´ë¼ë©´ í•­ìƒ refetchê°€ ë°œìƒí•œë‹¤.
- inactive Queryë“¤ì€ 5ë¶„ ë’¤ì— GCì— ì˜í•´ ì²˜ë¦¬ëœë‹¤.
- Query ì‹¤íŒ¨ ì‹œ 3ë²ˆê¹Œì§€ retryí•œë‹¤.

## â˜¸ï¸ ì¿ ë²„ë„¤í‹°ìŠ¤

### `kubectl apply`
[kubectl apply docs](https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands#apply)
- í™˜ê²½ì„¤ì •ì„ ì ìš©í•  ë•Œ ì‚¬ìš© (Apply a configuration to a resource by filename or stdin)
```bash
$ kubectl apply (-f FILENAME | -k DIRECTORY)
```
